name: Package Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'package.json'
      - '.npmignore'
      - '.gitignore'
      - 'tsconfig.json'
      - 'src/**'
      - 'scripts/build-cjs.js'
      - 'scripts/check-npm-package.js'
  push:
    branches: [main]
    paths:
      - 'package.json'
      - '.npmignore'
      - '.gitignore'
      - 'tsconfig.json'
      - 'src/**'
      - 'scripts/build-cjs.js'
      - 'scripts/check-npm-package.js'

jobs:
  check-package:
    runs-on: ubuntu-latest
    name: Verify npm package contents

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Verify build output
        run: |
          echo "ðŸ“ Checking dist directory contents:"
          ls -la dist/
          if [ ! -f "dist/index.js" ]; then
            echo "âŒ dist/index.js is missing!"
            exit 1
          fi
          if [ ! -f "dist/index.d.ts" ]; then
            echo "âŒ dist/index.d.ts is missing!"
            exit 1
          fi
          echo "âœ… All required dist files present"

      - name: Check package contents
        run: npm run check:package

      - name: Verify package size
        run: |
          # Get package size
          SIZE_OUTPUT=$(npm pack --dry-run --json)
          SIZE_KB=$(echo "$SIZE_OUTPUT" | jq '.[0].size' | awk '{print $1/1024}')
          UNPACKED_KB=$(echo "$SIZE_OUTPUT" | jq '.[0].unpackedSize' | awk '{print $1/1024}')

          echo "ðŸ“¦ Package size: ${SIZE_KB} KB"
          echo "ðŸ“‚ Unpacked size: ${UNPACKED_KB} KB"

          # Fail if package is too large (e.g., > 1MB packed)
          if (( $(echo "$SIZE_KB > 1024" | bc -l) )); then
            echo "âŒ Package is too large! Size: ${SIZE_KB} KB (limit: 1024 KB)"
            exit 1
          fi

      - name: Test package installation
        run: |
          # Create a test directory
          mkdir -p /tmp/test-install
          cd /tmp/test-install

          # Pack the package
          cd $GITHUB_WORKSPACE

          # First try to pack with JSON output
          if PACK_OUTPUT=$(npm pack --json 2>/dev/null); then
            # Try to extract filename from JSON
            PACKAGE_FILE=$(echo "$PACK_OUTPUT" | jq -r '.[0].filename' 2>/dev/null || echo "")
            
            if [ -z "$PACKAGE_FILE" ]; then
              echo "âš ï¸  Failed to extract filename from JSON output, using fallback"
              PACKAGE_FILE=$(ls node-email-verifier-*.tgz 2>/dev/null | head -n 1 || echo "")
            fi
          else
            echo "âš ï¸  npm pack --json failed, trying without JSON flag"
            npm pack
            PACKAGE_FILE=$(ls node-email-verifier-*.tgz 2>/dev/null | head -n 1 || echo "")
          fi

          # Verify we found the package file
          if [ -z "$PACKAGE_FILE" ] || [ ! -f "$PACKAGE_FILE" ]; then
            echo "âŒ Failed to create or find package file"
            exit 1
          fi

          echo "âœ… Found package file: $PACKAGE_FILE"
          mv "$PACKAGE_FILE" /tmp/test-install/
          cd /tmp/test-install

          # Initialize a test project
          npm init -y --silent

          # Install the packed package
          npm install "./$PACKAGE_FILE" --silent

          # Test ESM import
          echo 'import emailValidator from "node-email-verifier"; console.log("âœ“ ESM import works");' > test.mjs
          node test.mjs

          # Test CommonJS require
          echo 'const emailValidator = require("node-email-verifier"); console.log("âœ“ CommonJS require works");' > test.js
          node test.js

          # Test TypeScript types
          npm install --save-dev typescript @types/node
          echo '{"compilerOptions":{"module":"commonjs","target":"es2020","moduleResolution":"node","esModuleInterop":true,"skipLibCheck":true}}' > tsconfig.json
          echo 'const emailValidator = require("node-email-verifier"); console.log("âœ“ TypeScript types work");' > test-types.ts
          npx tsc --noEmit test-types.ts
          echo "âœ“ TypeScript compilation successful"

          echo "âœ… Package installation test passed!"
